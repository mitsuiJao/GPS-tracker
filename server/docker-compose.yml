version: "3.8"
services:
    mosquitto:
        image: eclipse-mosquitto:2.0
        container_name: mosquitto
        ports:
            - "1883:1883"
            - "9001:9001"
        restart: always
        volumes:
            - ./mosquitto/config:/mosquitto/config
            - ./mosquitto/data:/mosquitto/data

    db:
        image: postgres:17-alpine
        container_name: bike-db
        restart: always
        environment:
            POSTGRES_USER: nishima
            POSTGRES_PASSWORD: nishima 
            POSTGRES_DB: biketracker
        volumes:
            - ./db_data:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U nishima -d biketracker || exit 1"]
            interval: 10s
            timeout: 10s
            retries: 5
            start_period: 5s

    worker:
        build: ./worker
        container_name: bike_worker
        volumes:
            - ./worker:/app
        restart: always
        depends_on:
            db:
                condition: service_healthy
        environment:
            MQTT_BROKER: mosquitto
            DB_HOST: db

    web:
        image: node:18-alpine
        ports:
            - "3000:3000"
        volumes:
            - "./web:/web"
        depends_on:
            - worker